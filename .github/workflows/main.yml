name: Intense Afterimage Effect

on:
  workflow_dispatch:

jobs:
  process-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ffmpeg (Static Build)
        run: |
          echo "Downloading ffmpeg..."
          mkdir -p ffmpeg_static
          wget -q https://johnvansickle.com/ffmpeg/builds/ffmpeg-release-amd64-static.tar.xz
          echo "Extracting ffmpeg..."
          tar -xf ffmpeg-release-amd64-static.tar.xz -C ffmpeg_static --strip-components=1
          echo "Adding ffmpeg to PATH..."
          echo "$PWD/ffmpeg_static" >> $GITHUB_PATH
          echo "FFmpeg version:"
          ./ffmpeg_static/ffmpeg -version

      - name: Download Video
        run: |
          echo "Downloading v1 (ssstwitter)..."
          wget -q -O v1.mp4 "https://github.com/Emon2358/4949downloader/blob/main/downloads/ssstwitter.com_1759535411922.mp4?raw=true"
          echo "Download complete."

      - name: Run Video Processing (Intense Effect)
        run: |
          echo "Starting FFmpeg processing..."
          ffmpeg -y \
            -i v1.mp4 \
            -filter_complex " \
              [0:v]scale=1280:720,setsar=1[v1_base]; \
              [v1_base]edgedetect=mode=canny[edges]; \
              [edges]format=rgba, \
                     colorchannelmixer=rr=0.54:gr=0:br=0: \
                                     rg=0:gg=0.27:bg=0: \
                                     rb=0:gb=0:bb=0.07[rust_color]; \
              [rust_color]tblend=all_expr='A*0.9+B*0.1'[final_video] \
            " \
            -map "[final_video]" -map "0:a?" \
            -c:v libx264 -preset fast -crf 23 \
            -c:a aac -b:a 192k -shortest \
            processed_video.mp4
          echo "FFmpeg processing complete."

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-video
          path: processed_video.mp4
