name: Intense Afterimage Effect

on:
  workflow_dispatch:

jobs:
  process-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ffmpeg (Static Build)
        run: |
          echo "Downloading ffmpeg..."
          mkdir -p ffmpeg_static
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz -O ffmpeg.tar.xz
          echo "Extracting ffmpeg..."
          tar -xf ffmpeg.tar.xz -C ffmpeg_static --strip-components=1
          
          echo "Listing extracted files:"
          ls -R ffmpeg_static
          
          # 'ffmpeg'実行ファイルを探し、その親ディレクトリを取得
          FFMPEG_DIR=$(find $PWD/ffmpeg_static -type f -name ffmpeg -exec dirname {} \;)
          
          if [ -z "$FFMPEG_DIR" ]; then
            echo "Error: ffmpeg executable not found after extraction."
            exit 1
          fi
          
          echo "Found ffmpeg in: $FFMPEG_DIR"
          echo "Adding $FFMPEG_DIR to PATH..."
          # 実行ファイルが含まれるディレクトリをPATHに追加
          echo "$FFMPEG_DIR" >> $GITHUB_PATH
          
          echo "FFmpeg version:"
          # 見つけたパスから直接実行してバージョン確認
          $FFMPEG_DIR/ffmpeg -version

      - name: Download Video
        run: |
          echo "Downloading v1 (ssstwitter)..."
          wget -q -O v1.mp4 "https://github.com/Emon2358/4949downloader/blob/main/downloads/ssstwitter.com_1759535411922.mp4?raw=true"
          echo "Download complete."

      - name: Run Video Processing (Intense Effect)
        run: |
          echo "Starting FFmpeg processing..."
          ffmpeg -y \
            -i v1.mp4 \
            -filter_complex " \
              [0:v]scale=1280:720,setsar=1[v1_base]; \
              [v1_base]edgedetect=mode=canny[edges]; \
              [edges]format=rgba, \
                     colorchannelmixer=rr=0.54:gr=0:br=0: \
                                     rg=0:gg=0.27:bg=0: \
                                     rb=0:gb=0:bb=0.07[rust_color]; \
              [rust_color]tblend=all_expr='A*0.9+B*0.1'[final_video] \
            " \
            -map "[final_video]" -map "0:a?" \
            -c:v libx264 -preset fast -crf 23 \
            -c:a aac -b:a 192k -shortest \
            processed_video.mp4
          echo "FFmpeg processing complete."

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-video
          path: processed_video.mp4
